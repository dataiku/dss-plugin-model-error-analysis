<div class="template" ng-controller="EditController" ng-click="closeColorPicker($event)" ng-keydown="saveShortcut($event)" tabindex="0">
    <div ng-if="modal.type"
         class="modal-background"
         tabindex=0
         ng-keyup="$event.keyCode == 27 && removeModal()"
         ng-click="removeModal($event)">
    </div>
    <div class="tree-visualization tree-visualization--tree">
        <div class="toolbar-header" ng-class="{'toolbar-header--expanded': !hideText}">
            <div class="toolbar-header__row">
                <div class="expandable-introduction-text" ng-class="{'expandable-introduction-text--expanded': !hideText}">
                    <div class="expand-text">
                        <span class="link" ng-click="hideText = !hideText">
                            How does it work ?<i class="chevron-no-decoration" ng-class="{'icon-chevron-down': hideText, 'icon-chevron-up': !hideText}"></i>
                        </span>
                    </div>
                    <div class="introduction-text" ng-if="!hideText">
                        <p>
                            Model Error Analysis highlights the samples where your original model (id: {{ modelId }}) makes most of its errors.
                        </p>
                        <p>
                            The Decision Tree in the view below is another model that has been trained on the test set of the original one, to predict whether the original model correctly predicts its own target.  
                            If the original model is a classification, a prediction is correct if the original model predicts the correct class.
                            If the original model is a regression, a prediction is correct if the original model predicts a value within a threshold of the correct one.
                        </p>
                        <p>
                            The nodes of the tree bin the test samples of the original model into subsets sharing similar feature values.
                            Selecting a node will display detailed statistics regarding the errors in the subset defined by the node, compared to the whole set.
                            See the <a class="link">Plugin documentation&nbsp;<i class="icon-external-link"></i></a>.
                        </p>
                    </div>
                </div>
                <div ng-class="{'metrics': hideText, 'metrics--expanded': !hideText}">
                    <div class="metric">
                        <span class="metric__value" ng-show="metrics && metrics.estimated">{{ toFixedIfNeeded(1 - metrics.estimated, 3, true) }}</span>
                        <span class="metric__value" ng-show="!metrics ||  !metrics.estimated">&hellip;</span>
                        <div>
                            <div class="metric__name">Original model error rate</div>
                            <span class="metric__explanation" ng-if="!hideText">Actual proportion of wrong predictions from the original model (id: {{modelId}})</span>
                        </div>
                    </div>
                    <div class="metric">
                        <span class="metric__value" ng-show="metrics && metrics.actual">{{ toFixedIfNeeded(1 - metrics.actual, 3, true) }}</span>
                        <span class="metric__value" ng-show="!metrics || !metrics.actual">&hellip;</span>
                        <div>
                            <div class="metric__name">Predicted error rate</div>
                            <span class="metric__explanation" ng-if="!hideText">Predicted proportion of wrong predictions from the original model (id :{{modelId}})</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="toolbar-header__row">
                <div class="tree-legend-container">
                    <div class="tree-legend">
                        <div class="tree-legend_item tree-legend_edge">
                            <svg height="100%" width="100%">
                                <g>
                                    <path id="edge-legend" d="M0,0 C0,12 24,12 24,28"></path>
                                    <text>
                                        <textPath href="#edge-legend" startOffset="50%">X</textPath>
                                    </text>
                                </g>   
                            </svg>
                        </div>
                        <div class="tree-legend-desc">
                            <span class="tree-legend-desc-short">Global error</span>
                            <span class="tree-legend-desc-full" ng-if="!hideText">(% wrong predictions over total)</span>
                        </div>
                    </div>
                    <div class="tree-legend">
                        <div class="tree-legend_item tree-legend_pie">
                            <svg height="100%" width="100%"></svg>
                        </div>
                        <div class="tree-legend-desc">
                            <span class="tree-legend-desc-short">Local error</span>
                            <span class="tree-legend-desc-full" ng-if="!hideText">(% wrong predictions over node samples)</span>
                        </div>
                    </div>
                </div>
                <div class="icons-div">
                    <span ng-if="zoomBackHovered || zoomFitHovered">
                        {{ zoomBackHovered ? 'Zoom on selected node' : ''}}{{ zoomFitHovered ? 'See whole tree' : ''}}
                    </span>
                    <img class="zoom-icon"
                        src="/plugins/model-error-analysis/resource/img/fit.png"
                        ng-mouseover="zoomFitHovered = true" ng-mouseleave="zoomFitHovered = false"
                        ng-click="zoomFit()"
                        height="20px">
                    </img>
                    <img class="zoom-icon"
                        src="/plugins/model-error-analysis/resource/img/100.png"
                        ng-mouseover="zoomBackHovered = true" ng-mouseleave="zoomBackHovered = false"
                        ng-click="selectedNode && zoomBack()"
                        height="20px">
                    </img>
                </div>
            </div>
        </div>
        <div class="tree" ng-class="{'tree--no-selection': loadingTree || !selectedNode && !hideExploreInfo}" ng-mouseover="hideExploreInfo = true" ng-mouseleave="hideExploreInfo = false">
            <div class="empty-panel"
                 ng-if="loadingTree || !selectedNode && !hideExploreInfo">
                    Drag and zoom to explore the tree
            </div>
            <spinner ng-if="loadingTree"></spinner>
        </div>
    </div>
    <div class="histogram-panel" ng-include="'/plugins/model-error-analysis/resource/templates/histograms.html'" ng-show="selectedNode && !loadingHistogram"></div>
    <div class="histogram-panel--empty empty-panel" ng-show="!selectedNode">
        Select a node
    </div>
</div>
