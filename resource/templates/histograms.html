<div class="histogram-panel-selected-samples" ng-show="selectedNode && !displayHelp">
    <div class="selected-node-info">
        <div class="selected-samples-section">
            <div class="header header-div top-header">
                <div class="decision-rule__header">Selected samples</div>
                <div>
                    <span ng-show="helpHovered" class="help-text">Help</span>
                    <i ng-mouseover="helpHovered = true"
                    ng-mouseleave="helpHovered = false"
                    class="icon-question-sign interaction-icon"
                    ng-click="displayHelp = true"></i>
                </div>
            </div>
            <p>
                <strong>{{ selectedNode.samples[0] }}</strong> samples at the selected node (<strong>{{ toFixedIfNeeded(selectedNode.samples[1], 2, true) }}%</strong> of all the samples).
            </p>
            <div ng-if="decisionRule.length > 0">
                <div class="decision-rule__subheader">
                    Defined by
                </div>
                <div class="info-section" ng-class="{'info-section--expanded': displayRule}">
                    <div class="info" ng-repeat="rule in decisionRule" title="{{ rule.left + ' ' + rule.middle + ' ' + rule.right }}">
                        <span ng-if="$index">â†³&nbsp;</span>
                        <div class="ellipsed-text" ng-class="{'no-shrink-no-grow': rule.numerical, 'no-grow': !rule.numerical}" ng-if="rule.left">{{ rule.left }}&nbsp;</div>
                        <div class="ellipsed-text" ng-class="{'no-shrink-no-grow': !rule.numerical, 'no-grow': rule.numerical}">{{ rule.middle }}&nbsp;</div>
                        <div class="ellipsed-text" ng-class="{'no-shrink-no-grow': rule.numerical, 'no-grow': !rule.numerical}" ng-if="rule.right">{{ rule.right }}</div>
                    </div>
                </div>
                <div class="show-more" ng-show="decisionRule.length > 3">
                    <span class="link" ng-click="displayRule = !displayRule">
                        Show {{ displayRule ? 'less' : 'more' }}<i class="chevron" ng-class="{'icon-chevron-down': !displayRule, 'icon-chevron-up': displayRule}"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="error-section">
            <div class="placeholder-node">
                <svg height="100%" width="100%"></svg>
            </div>
            <div>
                <p>
                    <strong>{{ toFixedIfNeeded(selectedNode.localError*100, 2, true) }}%</strong> of the selected samples are wrong predictions.
                </p>
                <p>
                    They represent <strong>{{ toFixedIfNeeded(selectedNode.global_error*100, 2, true) }}%</strong> of total wrong predictions.
                </p>
            </div>
        </div>
    </div>

    <div class="histograms-container">
        <div class="legend-container">
            <div class="feature-selector" ng-click="$event.stopPropagation()">
                <span class="feature-selector__title" ng-click="interactWithFeatureSelector()">Feature distribution <i ng-class="{'icon-caret-down': !featureSelectorShown, 'icon-caret-up': featureSelectorShown}"></i></span>
                <div class="feature-selector__body" ng-if="featureSelectorShown">
                    <div class="feature-selector-row" ng-click="feature.$selected = !feature.$selected" ng-repeat="feature in rankedFeatures">
                        <input type="checkbox" ng-model="feature.$selected" ng-click="$event.stopPropagation()">
                        &nbsp;
                        <i class="icon-font" ng-show="!feature.numerical"></i>
                        <div class="numerical" ng-show="feature.numerical">#</div>
                        <div class="ellipsed-text">&nbsp;{{ feature.name }}</div>
                    </div>
                </div>
            </div>
            <div class="legend-histograms">
                <div class="legend-histograms__local">
                    <svg height="20px" width="25px">
                        <g>
                            <rect class="color-bar color-bar--error" x="4"></rect>
                            <rect class="color-bar color-bar--correct" x="12"> </rect>
                        </g>
                    </svg>
                    <div>In selected samples</div>
                </div>
                <div class="legend-histograms__global"
                    ng-click="globalLegendIsHovered = !globalLegendIsHovered; displayOrHideGlobalData()"
                    ng-class="{'legend-histograms__global--disabled': !!seeGlobalChartData === !!globalLegendIsHovered}" 
                    ng-mouseenter="globalLegendIsHovered = true"
                    ng-mouseleave="globalLegendIsHovered = false">
                    <svg height="20px" width="25px">
                        <g>
                            <rect class="color-bar color-bar--error color-bar__global-legend" ng-class="{'color-bar__global-legend--disabled': seeGlobalChartData === globalLegendIsHovered}" x="4"></rect>
                            <rect class="color-bar color-bar--correct color-bar__global-legend" ng-class="{'color-bar__global-legend--disabled': seeGlobalChartData === globalLegendIsHovered}" x="12"> </rect>
                        </g>
                    </svg>
                    <div>
                        In all samples
                        &nbsp;<i ng-class="{'icon-eye-open': !!seeGlobalChartData !== !!globalLegendIsHovered, 'icon-eye-close': !!seeGlobalChartData === !!globalLegendIsHovered}"></i></div>
                </div>
            </div>
        </div>
        <div class="histograms">  
            <div ng-repeat="feature in rankedFeatures | orderBy: 'rank'" ng-if="feature.$selected">
                <div class="header header-feature">
                    <div class="header-feature-desc header-div header-div--bolder">
                        <i class="icon-font header__icon" ng-show="!feature.numerical"></i>
                        <div class="numerical header__icon" ng-show="feature.numerical">#</div>
                        <div class="ellipsed-text" title="{{feature.name}}">{{feature.name}}</div>
                    </div>
                </div>
                <div class="histogram-placeholder histogram-placeholder-empty" ng-if="histData[feature.name] && histData[feature.name].count.length == 0">
                    <em>No values</em>
                </div>
                <div class="histogram-placeholder histogram-placeholder-empty" ng-if="!histData[feature.name] && featureSelectorShown">
                    <em>Chart data not yet loaded</em>
                </div>
                <div class="histogram-placeholder" ng-if="!histData[feature.name] && !featureSelectorShown">
                    <spinner></spinner>
                </div>
                <div histogram="{{feature.name}}" class="histogram-placeholder" ng-if="histData[feature.name] && histData[feature.name].count.length > 0">
                    <div class="histogram-svg"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="histogram-panel-empty" ng-show="!selectedNode || displayHelp">
    <div class="header header-div top-header">
        <div>How does it work ?</div>
        <div ng-show="selectedNode">
            <span ng-show="helpHovered" class="help-text">Close help</span>
            <i class="icon-question-sign interaction-icon"
            ng-mouseover="helpHovered = true"
            ng-mouseleave="helpHovered = false"
            ng-click="displayHelp = false"></i>
        </div>
    </div>
    <div class="plugin-explanation">
        <p>
            Model Error Analysis provides insights on features critically correlated with a model failures.
            This can give directions to improve model design, enhance data collection, or select critical samples for manual inspection.
        </p>
        <p>
            A decision tree is trained to predict whether your original model <strong ng-if="originalModelName">({{ originalModelName }})</strong> wrongly predicts its own target.
            <span ng-if="isRegression == false">A prediction from your original model is considered wrong if the predicted class is not the correct one.</span>
            <span ng-if="isRegression">A prediction from your original model is considered wrong if the predicted value is too far from the correct one (threshold used: 0.1).</span> <!-- TODO -->
        </p>
        <p>
            The tree is trained on the test set of your original model, meaning its nodes represent subsets of these test samples with similar feature values. This way, Model Error Analysis highlights the samples where your original model makes most of its wrong predictions.
        </p>
        <p>
            Select a node to display more information on its samples. Nodes with higher local error and higher fraction of total error should be of a greater interest for the error analysis.
        </p>
        <p>
            See the <a class="link">Plugin documentation&nbsp;<i class="icon-external-link"></i></a> for more information.
        </p>
    </div>
</div>